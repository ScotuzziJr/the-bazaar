{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<h2 class="mb-4">游닗 칔ltimas Postagens</h2>

{% for post in posts %}
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <!-- Cabe칞alho do post -->
        <div class="d-flex align-items-center mb-2">
            <a href="{% url 'profile' post.author.username %}">
                {% if post.author.profile.avatar %}
                    <img src="{{ post.author.profile.avatar.url }}" 
                         class="rounded-circle me-2" 
                         style="width:40px; height:40px; object-fit:cover;">
                {% else %}
                    <img src="https://via.placeholder.com/40" 
                         class="rounded-circle me-2">
                {% endif %}
            </a>
            <div>
                <strong><a href="{% url 'profile' post.author.username %}" class="text-decoration-none">{{ post.author.username }}</a></strong><br>
                <small class="text-muted">{{ post.created_at|date:"d/m/Y H:i" }}</small>
            </div>
        </div>

        <!-- Conte칰do -->
        <p>{{ post.content|linebreaks }}</p>

        {% if post.image %}
            <img src="{{ post.image.url }}" class="img-fluid rounded mb-2">
        {% endif %}

        <!-- Link para o projeto -->
        <p class="mb-1">
            <small>游늷 Projeto: <a href="{% url 'project_detail' post.project.pk %}">{{ post.project.title }}</a></small>
        </p>

        <!-- Bot칫es de intera칞칚o -->
        <div class="d-flex align-items-center mt-2">
            <button class="btn btn-sm btn-outline-primary like-btn me-2" data-post-id="{{ post.id }}">
                仇벒잺 {{ post.likes.count }}
            </button>
            <button class="btn btn-sm btn-outline-secondary toggle-comments" data-post-id="{{ post.id }}">
                游눫 {{ post.comments.count }}
            </button>
        </div>

        <!-- Se칞칚o de coment치rios (inicialmente escondida) -->
        <div class="comments-section mt-3" id="comments-{{ post.id }}" style="display:none;">
            <!-- Formul치rio de coment치rio -->
            {% if user.is_authenticated %}
                <form method="post" action="{% url 'add_comment' post.id %}" class="mb-2">
                    {% csrf_token %}
                    <textarea name="content" class="form-control mb-2" rows="2" placeholder="Escreva um coment치rio..."></textarea>
                    <button type="submit" class="btn btn-primary btn-sm">Comentar</button>
                </form>
            {% else %}
                <p class="text-muted">Entre para comentar.</p>
            {% endif %}

            <!-- Lista de coment치rios -->
            {% for comment in post.comments.all %}
                <div class="border rounded p-2 mb-2">
                    <strong>
                        <a href="{% url 'profile' comment.author.username %}">{{ comment.author.username }}</a>
                    </strong>
                    <small class="text-muted">{{ comment.created_at|date:"d/m/Y H:i" }}</small>
                    <p class="mb-0">{{ comment.content }}</p>
                </div>
            {% empty %}
                <p class="text-muted">Nenhum coment치rio ainda.</p>
            {% endfor %}
        </div>
    </div>
</div>
{% empty %}
<p class="text-muted">Nenhuma postagem ainda.</p>
{% endfor %}

<!-- Script de intera칞칚o -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Curtir/Descurtir
    document.querySelectorAll(".like-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const postId = this.dataset.postId;
            fetch(`/post/${postId}/like/`, { 
                method: "POST", 
                headers: { "X-CSRFToken": "{{ csrf_token }}" } 
            })
            .then(r => r.json())
            .then(data => {
                this.innerHTML = `仇벒잺 ${data.likes_count}`;
            });
        });
    });

    // Mostrar/Ocultar coment치rios
    document.querySelectorAll(".toggle-comments").forEach(btn => {
        btn.addEventListener("click", function() {
            const postId = this.dataset.postId;
            const section = document.getElementById(`comments-${postId}`);
            section.style.display = section.style.display === "none" ? "block" : "none";
        });
    });
});
</script>
{% endblock %}
